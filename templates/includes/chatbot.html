<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     CHATBOT MY KANTY ‚Äî VERSION CORRIG√âE CSRF
     Copiez dans : templates/includes/chatbot.html
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
{% load static %}

<style>
/* ‚îÄ‚îÄ CHATBOT WIDGET ‚îÄ‚îÄ */
#chat-bubble {
    position: fixed;
    bottom: 25px;
    right: 25px;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, #FF9933, #006B3F);
    color: white;
    border: none;
    cursor: pointer;
    z-index: 9000;
    box-shadow: 0 4px 20px rgba(255,153,51,0.5);
    font-size: 1.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
    animation: pulse-bubble 2s infinite;
}
#chat-bubble:hover { transform: scale(1.1); }

@keyframes pulse-bubble {
    0%, 100% { box-shadow: 0 4px 20px rgba(255,153,51,0.5); }
    50% { box-shadow: 0 4px 30px rgba(255,153,51,0.8); }
}

#chat-notif {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #C7511F;
    color: white;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    font-size: 0.7rem;
    font-weight: 800;
    display: flex;
    align-items: center;
    justify-content: center;
    display: none;
}

#chat-window {
    position: fixed;
    bottom: 98px;
    right: 25px;
    width: 370px;
    height: 530px;
    background: white;
    border-radius: 20px;
    box-shadow: 0 15px 50px rgba(0,0,0,0.2);
    z-index: 8999;
    display: none;
    flex-direction: column;
    overflow: hidden;
    font-family: 'Inter', sans-serif;
}

/* Header */
.chat-header {
    background: linear-gradient(135deg, #FF9933, #006B3F);
    padding: 16px 18px;
    color: white;
    display: flex;
    align-items: center;
    justify-content: space-between;
}
.chat-avatar {
    width: 38px;
    height: 38px;
    background: rgba(255,255,255,0.25);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    margin-right: 10px;
    flex-shrink: 0;
}
.chat-header-info { flex: 1; }
.chat-header-info strong { display: block; font-size: 0.95rem; }
.chat-header-info span { font-size: 0.75rem; opacity: 0.9; display: flex; align-items: center; gap: 5px; }
.online-dot { width: 7px; height: 7px; background: #7CFC00; border-radius: 50%; animation: blink 1.5s infinite; }
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.4} }
.chat-actions { display: flex; gap: 8px; }
.chat-actions button { background: rgba(255,255,255,0.2); border: none; color: white; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: 0.85rem; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
.chat-actions button:hover { background: rgba(255,255,255,0.35); }

/* Messages */
.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 14px;
    background: #F8F9FA;
    display: flex;
    flex-direction: column;
    gap: 10px;
}
.chat-messages::-webkit-scrollbar { width: 4px; }
.chat-messages::-webkit-scrollbar-thumb { background: #FF9933; border-radius: 2px; }

.msg { display: flex; gap: 8px; align-items: flex-end; max-width: 85%; }
.msg.bot { align-self: flex-start; }
.msg.user { align-self: flex-end; flex-direction: row-reverse; }
.msg-avatar { width: 28px; height: 28px; border-radius: 50%; background: linear-gradient(135deg,#FF9933,#006B3F); color: white; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; flex-shrink: 0; }
.msg-bubble { padding: 10px 14px; border-radius: 14px; font-size: 0.88rem; line-height: 1.5; }
.msg.bot .msg-bubble { background: white; color: #1a1a1a; border-radius: 4px 14px 14px 14px; box-shadow: 0 1px 4px rgba(0,0,0,0.08); }
.msg.user .msg-bubble { background: linear-gradient(135deg,#FF9933,#006B3F); color: white; border-radius: 14px 4px 14px 14px; }

/* Typing */
.typing-dots { display: flex; gap: 4px; padding: 12px 16px; background: white; border-radius: 4px 14px 14px 14px; box-shadow: 0 1px 4px rgba(0,0,0,0.08); }
.typing-dots span { width: 7px; height: 7px; background: #FF9933; border-radius: 50%; animation: bounce 1.2s infinite; }
.typing-dots span:nth-child(2) { animation-delay: 0.2s; }
.typing-dots span:nth-child(3) { animation-delay: 0.4s; }
@keyframes bounce { 0%,60%,100%{transform:translateY(0)} 30%{transform:translateY(-8px)} }

/* Suggestions */
.chat-suggestions {
    padding: 8px 12px;
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    background: white;
    border-top: 1px solid #F0F0F0;
}
.suggestion-btn {
    padding: 5px 10px;
    background: rgba(255,153,51,0.1);
    border: 1px solid rgba(255,153,51,0.3);
    border-radius: 15px;
    font-size: 0.75rem;
    cursor: pointer;
    color: #006B3F;
    font-weight: 600;
    transition: all 0.2s;
    white-space: nowrap;
}
.suggestion-btn:hover { background: #FF9933; color: white; border-color: #FF9933; }

/* Input */
.chat-input-area {
    padding: 12px 14px;
    background: white;
    border-top: 1px solid #F0F0F0;
    display: flex;
    gap: 8px;
    align-items: center;
}
#chat-input {
    flex: 1;
    padding: 10px 14px;
    border: 2px solid #E0E0E0;
    border-radius: 20px;
    font-size: 0.88rem;
    outline: none;
    font-family: 'Inter', sans-serif;
    color: #0F1111;
    transition: border-color 0.2s;
}
#chat-input:focus { border-color: #FF9933; }
#chat-send {
    width: 38px;
    height: 38px;
    background: linear-gradient(135deg,#FF9933,#006B3F);
    color: white;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    flex-shrink: 0;
}
#chat-send:hover { transform: scale(1.1); }
#chat-send:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

/* Mobile */
@media (max-width: 480px) {
    #chat-window { width: calc(100vw - 16px); right: 8px; bottom: 85px; height: 470px; }
    #chat-bubble { bottom: 18px; right: 12px; width: 54px; height: 54px; }
}
</style>

<!-- BOUTON CHATBOT -->
<button id="chat-bubble" onclick="toggleChat()" title="Parlez √† Kanty">
    <i class="fas fa-robot"></i>
    <span id="chat-notif">1</span>
</button>

<!-- FEN√äTRE CHAT -->
<div id="chat-window">
    <div class="chat-header">
        <div class="chat-avatar">ü§ñ</div>
        <div class="chat-header-info">
            <strong>Kanty ‚Äî Assistant My Kanty</strong>
            <span><span class="online-dot"></span> En ligne ‚Ä¢ R√©pond en quelques secondes</span>
        </div>
        <div class="chat-actions">
            <button onclick="clearChat()" title="Effacer"><i class="fas fa-trash-alt"></i></button>
            <button onclick="toggleChat()" title="Fermer"><i class="fas fa-times"></i></button>
        </div>
    </div>

    <div class="chat-messages" id="chat-messages"></div>

    <div class="chat-suggestions" id="chat-suggestions">
        <button class="suggestion-btn" onclick="sendSuggestion('Comment fonctionne l\'Escrow ?')">üîê Escrow</button>
        <button class="suggestion-btn" onclick="sendSuggestion('Comment devenir vendeur ?')">üè™ Vendeur</button>
        <button class="suggestion-btn" onclick="sendSuggestion('Comment passer une commande ?')">üõí Commander</button>
        <button class="suggestion-btn" onclick="sendSuggestion('Quelle est la commission ?')">üí∞ Commission</button>
        <button class="suggestion-btn" onclick="sendSuggestion('Comment vous contacter ?')">üìû Contact</button>
    </div>

    <div class="chat-input-area">
        <input type="text" id="chat-input" placeholder="Posez votre question..." maxlength="500"
               onkeypress="if(event.key==='Enter' && !event.shiftKey){event.preventDefault();sendMessage();}">
        <button id="chat-send" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
    </div>
</div>

<script>
let chatOpen = false;
let conversationHistory = [];
let notifShown = false;

const WELCOME_MSG = `Bonjour ! üëã Je suis **Kanty**, votre assistant My Kanty.

Je peux vous aider sur :
‚Ä¢ üîê Le syst√®me Escrow s√©curis√©
‚Ä¢ üè™ Devenir vendeur (commission 3%)
‚Ä¢ üõí Passer et suivre une commande
‚Ä¢ üí≥ Les moyens de paiement
‚Ä¢ üìû Contacter notre √©quipe

Comment puis-je vous aider ?`;

document.addEventListener('DOMContentLoaded', function() {
    appendMessage('bot', WELCOME_MSG);
    setTimeout(function() {
        if (!chatOpen && !notifShown) {
            document.getElementById('chat-notif').style.display = 'flex';
            notifShown = true;
        }
    }, 3000);
});

function toggleChat() {
    chatOpen = !chatOpen;
    const win = document.getElementById('chat-window');
    win.style.display = chatOpen ? 'flex' : 'none';
    document.getElementById('chat-notif').style.display = 'none';
    if (chatOpen) {
        document.getElementById('chat-input').focus();
        scrollToBottom();
    }
}

function formatText(text) {
    return text
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/\n/g, '<br>');
}

function appendMessage(role, text) {
    const container = document.getElementById('chat-messages');
    const div = document.createElement('div');
    div.className = `msg ${role}`;

    if (role === 'bot') {
        div.innerHTML = `
            <div class="msg-avatar">ü§ñ</div>
            <div class="msg-bubble">${formatText(text)}</div>`;
    } else {
        div.innerHTML = `
            <div class="msg-bubble">${formatText(text)}</div>
            <div class="msg-avatar" style="background:linear-gradient(135deg,#006B3F,#FF9933);">üë§</div>`;
    }

    container.appendChild(div);
    scrollToBottom();
}

function showTyping(show) {
    const existing = document.getElementById('typing-indicator');
    if (existing) existing.remove();
    if (show) {
        const container = document.getElementById('chat-messages');
        const div = document.createElement('div');
        div.className = 'msg bot';
        div.id = 'typing-indicator';
        div.innerHTML = `
            <div class="msg-avatar">ü§ñ</div>
            <div class="typing-dots">
                <span></span><span></span><span></span>
            </div>`;
        container.appendChild(div);
        scrollToBottom();
    }
}

function scrollToBottom() {
    const container = document.getElementById('chat-messages');
    container.scrollTop = container.scrollHeight;
}

function clearChat() {
    conversationHistory = [];
    document.getElementById('chat-messages').innerHTML = '';
    appendMessage('bot', WELCOME_MSG);
}

function sendSuggestion(text) {
    document.getElementById('chat-suggestions').style.display = 'none';
    document.getElementById('chat-input').value = text;
    sendMessage();
}

async function sendMessage() {
    const input = document.getElementById('chat-input');
    const text = input.value.trim();
    if (!text) return;

    input.value = '';
    document.getElementById('chat-send').disabled = true;
    document.getElementById('chat-suggestions').style.display = 'none';

    appendMessage('user', text);
    conversationHistory.push({ role: 'user', content: text });
    showTyping(true);

    try {
        // Appel √† l'endpoint Django (SANS CSRF token)
        const response = await fetch('/chatbot-api/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                messages: conversationHistory
            })
        });

        const data = await response.json();
        const reply = data.reply || "D√©sol√©, je n'ai pas pu r√©pondre. Contactez-nous au +228 93 33 78 02 üìû";

        conversationHistory.push({ role: 'assistant', content: reply });

        if (conversationHistory.length > 20) {
            conversationHistory = conversationHistory.slice(-20);
        }

        showTyping(false);
        appendMessage('bot', reply);

    } catch (error) {
        console.error('Chatbot error:', error);
        showTyping(false);
        appendMessage('bot', '‚ùå Erreur de connexion. Contactez-nous au **+228 93 33 78 02** üìû');
    }

    document.getElementById('chat-send').disabled = false;
    document.getElementById('chat-input').focus();
}
</script>