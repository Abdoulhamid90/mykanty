{% load static %}
<!-- CHATBOT MY KANTY - √Ä inclure dans tous vos templates -->

<!-- BOUTON FLOTTANT -->
<div id="chat-bubble" onclick="toggleChat()" title="Assistant My Kanty">
    <div class="bubble-inner">
        <i class="fas fa-robot" id="bubble-icon"></i>
        <i class="fas fa-times" id="bubble-close" style="display:none;"></i>
    </div>
    <span class="bubble-badge" id="bubble-badge" style="display:none;">1</span>
    <div class="bubble-pulse"></div>
</div>

<!-- FEN√äTRE DU CHATBOT -->
<div id="chat-window">
    <div class="chat-header">
        <div class="chat-header-left">
            <div class="chat-avatar">
                <i class="fas fa-robot"></i>
            </div>
            <div>
                <div class="chat-name">Kanty IA</div>
                <div class="chat-status"><span class="status-dot"></span> En ligne</div>
            </div>
        </div>
        <div class="chat-header-right">
            <button onclick="clearChat()" title="Effacer la conversation"><i class="fas fa-trash-alt"></i></button>
            <button onclick="toggleChat()" title="Fermer"><i class="fas fa-times"></i></button>
        </div>
    </div>

    <div class="chat-messages" id="chat-messages">
        <!-- Message de bienvenue -->
        <div class="msg bot-msg">
            <div class="msg-avatar"><i class="fas fa-robot"></i></div>
            <div class="msg-content">
                <div class="msg-bubble">
                    Bonjour ! üëã Je suis <strong>Kanty</strong>, votre assistant My Kanty.<br><br>
                    Je peux vous aider avec :
                    <div class="quick-topics">
                        <span onclick="sendQuick('Comment fonctionne le paiement Escrow ?')">üîê Escrow</span>
                        <span onclick="sendQuick('Comment devenir vendeur ?')">üè™ Devenir vendeur</span>
                        <span onclick="sendQuick('Comment passer une commande ?')">üõí Commander</span>
                        <span onclick="sendQuick('Quels sont les frais de commission ?')">üí∞ Commission</span>
                        <span onclick="sendQuick('Comment vous contacter ?')">üìû Contact</span>
                    </div>
                </div>
                <div class="msg-time">maintenant</div>
            </div>
        </div>
    </div>

    <div class="chat-typing" id="chat-typing" style="display:none;">
        <div class="msg-avatar"><i class="fas fa-robot"></i></div>
        <div class="typing-dots"><span></span><span></span><span></span></div>
    </div>

    <div class="chat-input-area">
        <div class="chat-input-wrapper">
            <input
                type="text"
                id="chat-input"
                placeholder="Posez votre question..."
                onkeypress="handleKeyPress(event)"
                maxlength="500"
            >
            <button onclick="sendMessage()" id="send-btn">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
        <div class="chat-footer-note">
            <i class="fas fa-shield-alt"></i> Propuls√© par l'IA ‚Äî My Kanty
        </div>
    </div>
</div>

<style>
/* ‚îÄ‚îÄ BUBBLE ‚îÄ‚îÄ */
#chat-bubble {
    position: fixed;
    bottom: 28px;
    right: 28px;
    width: 62px;
    height: 62px;
    background: linear-gradient(135deg, #FF9933, #006B3F);
    border-radius: 50%;
    cursor: pointer;
    z-index: 9000;
    box-shadow: 0 6px 25px rgba(255,153,51,0.5);
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}
#chat-bubble:hover { transform: scale(1.1); box-shadow: 0 8px 30px rgba(255,153,51,0.6); }
.bubble-inner { display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; }
#chat-bubble i { color: white; font-size: 1.5rem; }
.bubble-badge {
    position: absolute;
    top: -4px;
    right: -4px;
    background: #C7511F;
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 0.7rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid white;
}
.bubble-pulse {
    position: absolute;
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background: rgba(255,153,51,0.3);
    animation: pulse-ring 2s ease-out infinite;
}
@keyframes pulse-ring {
    0% { transform: scale(1); opacity: 0.8; }
    100% { transform: scale(1.6); opacity: 0; }
}

/* ‚îÄ‚îÄ WINDOW ‚îÄ‚îÄ */
#chat-window {
    position: fixed;
    bottom: 105px;
    right: 28px;
    width: 370px;
    height: 540px;
    background: white;
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.2);
    z-index: 8999;
    display: none;
    flex-direction: column;
    overflow: hidden;
    animation: slideUp 0.3s ease;
    font-family: 'Inter', sans-serif;
}
#chat-window.open { display: flex; }
@keyframes slideUp {
    from { opacity: 0; transform: translateY(20px) scale(0.95); }
    to { opacity: 1; transform: translateY(0) scale(1); }
}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
.chat-header {
    background: linear-gradient(135deg, #FF9933, #006B3F);
    padding: 16px 18px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: white;
}
.chat-header-left { display: flex; align-items: center; gap: 12px; }
.chat-avatar {
    width: 42px;
    height: 42px;
    background: rgba(255,255,255,0.2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    border: 2px solid rgba(255,255,255,0.4);
}
.chat-name { font-weight: 700; font-size: 1rem; }
.chat-status { font-size: 0.75rem; opacity: 0.9; display: flex; align-items: center; gap: 5px; }
.status-dot {
    width: 7px;
    height: 7px;
    background: #90EE90;
    border-radius: 50%;
    display: inline-block;
    animation: blink 1.5s ease-in-out infinite;
}
@keyframes blink { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }
.chat-header-right { display: flex; gap: 8px; }
.chat-header-right button {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 0.85rem;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
}
.chat-header-right button:hover { background: rgba(255,255,255,0.35); }

/* ‚îÄ‚îÄ MESSAGES ‚îÄ‚îÄ */
.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 18px 14px;
    display: flex;
    flex-direction: column;
    gap: 14px;
    background: #F8F9FA;
}
.chat-messages::-webkit-scrollbar { width: 4px; }
.chat-messages::-webkit-scrollbar-track { background: transparent; }
.chat-messages::-webkit-scrollbar-thumb { background: #D5D9D9; border-radius: 2px; }

.msg { display: flex; gap: 9px; align-items: flex-end; }
.msg-avatar {
    width: 30px;
    height: 30px;
    background: linear-gradient(135deg, #FF9933, #006B3F);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 0.75rem;
    flex-shrink: 0;
}
.msg-content { display: flex; flex-direction: column; gap: 3px; max-width: 82%; }
.msg-bubble {
    padding: 10px 14px;
    border-radius: 16px 16px 16px 4px;
    background: white;
    color: #0F1111;
    font-size: 0.88rem;
    line-height: 1.55;
    box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    word-break: break-word;
}
.msg-time { font-size: 0.7rem; color: #999; padding-left: 4px; }

/* Message utilisateur */
.user-msg { flex-direction: row-reverse; }
.user-msg .msg-bubble {
    background: linear-gradient(135deg, #FF9933, #006B3F);
    color: white;
    border-radius: 16px 16px 4px 16px;
}
.user-msg .msg-avatar { background: #D5D9D9; color: #565959; }
.user-msg .msg-content { align-items: flex-end; }
.user-msg .msg-time { padding-left: 0; padding-right: 4px; }

/* Suggestions rapides */
.quick-topics { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px; }
.quick-topics span {
    background: #FFF3E0;
    color: #E65100;
    padding: 5px 10px;
    border-radius: 20px;
    font-size: 0.78rem;
    cursor: pointer;
    border: 1px solid #FFD0A0;
    transition: all 0.2s;
    white-space: nowrap;
}
.quick-topics span:hover { background: #FF9933; color: white; border-color: #FF9933; }

/* ‚îÄ‚îÄ TYPING ‚îÄ‚îÄ */
.chat-typing {
    padding: 8px 14px;
    display: flex;
    align-items: center;
    gap: 9px;
    background: #F8F9FA;
}
.typing-dots {
    background: white;
    padding: 10px 14px;
    border-radius: 16px;
    display: flex;
    gap: 4px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.08);
}
.typing-dots span {
    width: 7px;
    height: 7px;
    background: #FF9933;
    border-radius: 50%;
    animation: bounce 1.2s ease-in-out infinite;
}
.typing-dots span:nth-child(2) { animation-delay: 0.2s; }
.typing-dots span:nth-child(3) { animation-delay: 0.4s; }
@keyframes bounce {
    0%,80%,100% { transform: translateY(0); opacity: 0.5; }
    40% { transform: translateY(-8px); opacity: 1; }
}

/* ‚îÄ‚îÄ INPUT ‚îÄ‚îÄ */
.chat-input-area {
    padding: 12px 14px 10px;
    background: white;
    border-top: 1px solid #F0F0F0;
}
.chat-input-wrapper {
    display: flex;
    gap: 8px;
    align-items: center;
    background: #F8F9FA;
    border: 2px solid #E0E0E0;
    border-radius: 25px;
    padding: 6px 8px 6px 16px;
    transition: border-color 0.2s;
}
.chat-input-wrapper:focus-within { border-color: #FF9933; }
#chat-input {
    flex: 1;
    border: none;
    background: transparent;
    font-family: 'Inter', sans-serif;
    font-size: 0.88rem;
    color: #0F1111;
    outline: none;
}
#chat-input::placeholder { color: #999; }
#send-btn {
    background: linear-gradient(135deg, #FF9933, #006B3F);
    border: none;
    width: 34px;
    height: 34px;
    border-radius: 50%;
    color: white;
    cursor: pointer;
    font-size: 0.85rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    flex-shrink: 0;
}
#send-btn:hover { transform: scale(1.1); }
#send-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
.chat-footer-note {
    text-align: center;
    font-size: 0.7rem;
    color: #999;
    margin-top: 6px;
}

/* RESPONSIVE */
@media (max-width: 480px) {
    #chat-window { width: calc(100vw - 20px); right: 10px; bottom: 95px; height: 480px; }
    #chat-bubble { bottom: 20px; right: 15px; }
}
</style>

<script>
let chatOpen = false;
let isLoading = false;
let conversationHistory = [];

const SYSTEM_PROMPT = `Tu es Kanty, l'assistant IA officiel de My Kanty...

CONTACTS MY KANTY :
- Fondateur : Abdoul-Hamid Mohamed
- Togo : +228 93 33 78 02
- Niger : +227 92 53 44 35
- WhatsApp : +228 93 33 78 02
- Email : abdoul.mohammed91@gmail.com

PAIEMENTS :
- TOGO : Mixx/Tmoney +228 72 22 23 72 | Nita d√©p√¥t sur +228 72 22 23 72
- NIGER : Mobile Money +227 92 53 44 35 | Nita d√©p√¥t sur +227 92 53 44 35
...`;

TON R√îLE :
- Aider les acheteurs √† passer des commandes et comprendre le processus
- Guider les vendeurs dans leur d√©marche
- Expliquer le syst√®me de paiement Escrow
- R√©pondre aux questions sur la commission, les livraisons, les litiges
- Orienter les utilisateurs vers les bonnes pages

INFORMATIONS CL√âS SUR MY KANTY :
- Marketplace au Togo üáπüá¨ et Niger üá≥üá™
- Paiement : Mobile Money ou Nita (transfert bancaire)
- Commission vendeur : 5% par vente
- Syst√®me Escrow : l'argent est bloqu√© jusqu'√† confirmation de livraison
- Paiement vendeur lib√©r√© 24-48h apr√®s confirmation de livraison
- Contact : +228 90 12 34 56 / contact@mykanty.com
- Heures : Lun-Sam 8h-18h

PAGES IMPORTANTES :
- Devenir vendeur : /accounts/become-seller/
- Mes commandes : /orders/my-orders/
- Guide Escrow : /legal/escrow-guide/
- CGV : /legal/cgv/
- Panier : /orders/cart/

STYLE DE R√âPONSE :
- Sois chaleureux, professionnel et concis
- R√©ponds en fran√ßais
- Utilise des √©mojis avec mod√©ration
- Si tu ne sais pas, dis-le honn√™tement et propose de contacter le support
- Tes r√©ponses ne doivent pas d√©passer 3-4 phrases sauf si n√©cessaire`;

function toggleChat() {
    chatOpen = !chatOpen;
    const win = document.getElementById('chat-window');
    const icon = document.getElementById('bubble-icon');
    const closeIcon = document.getElementById('bubble-close');
    const badge = document.getElementById('bubble-badge');

    if (chatOpen) {
        win.classList.add('open');
        icon.style.display = 'none';
        closeIcon.style.display = 'block';
        badge.style.display = 'none';
        setTimeout(() => document.getElementById('chat-input').focus(), 300);
    } else {
        win.classList.remove('open');
        icon.style.display = 'block';
        closeIcon.style.display = 'none';
    }
}

function handleKeyPress(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
}

function sendQuick(text) {
    document.getElementById('chat-input').value = text;
    sendMessage();
}

async function sendMessage() {
    const input = document.getElementById('chat-input');
    const text = input.value.trim();
    if (!text || isLoading) return;

    input.value = '';
    isLoading = true;
    document.getElementById('send-btn').disabled = true;

    // Afficher le message utilisateur
    appendMessage('user', text);

    // Ajouter √† l'historique
    conversationHistory.push({ role: 'user', content: text });

    // Afficher le typing
    showTyping(true);
    scrollToBottom();

    try {
        const response = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                model: 'claude-sonnet-4-5-20250929',
                max_tokens: 1000,
                system: SYSTEM_PROMPT,
                messages: conversationHistory
            })
        });

        const data = await response.json();
        const reply = data.content[0].text;

        // Ajouter la r√©ponse √† l'historique
        conversationHistory.push({ role: 'assistant', content: reply });

        // Garder l'historique √† 20 messages max
        if (conversationHistory.length > 20) {
            conversationHistory = conversationHistory.slice(-20);
        }

        showTyping(false);
        appendMessage('bot', reply);

    } catch (error) {
        showTyping(false);
        appendMessage('bot', '‚ö†Ô∏è D√©sol√©, je rencontre une difficult√© technique. Contactez-nous au +228 90 12 34 56 ou par email √† contact@mykanty.com');
    }

    isLoading = false;
    document.getElementById('send-btn').disabled = false;
    input.focus();
    scrollToBottom();
}

function appendMessage(role, text) {
    const container = document.getElementById('chat-messages');
    const now = new Date();
    const time = now.getHours() + ':' + String(now.getMinutes()).padStart(2, '0');

    const isBot = role === 'bot';
    const formattedText = text
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\n/g, '<br>');

    const html = `
        <div class="msg ${isBot ? 'bot-msg' : 'user-msg'}">
            <div class="msg-avatar">
                <i class="fas fa-${isBot ? 'robot' : 'user'}"></i>
            </div>
            <div class="msg-content">
                <div class="msg-bubble">${formattedText}</div>
                <div class="msg-time">${time}</div>
            </div>
        </div>
    `;

    container.insertAdjacentHTML('beforeend', html);
    scrollToBottom();
}

function showTyping(show) {
    document.getElementById('chat-typing').style.display = show ? 'flex' : 'none';
}

function scrollToBottom() {
    const container = document.getElementById('chat-messages');
    container.scrollTop = container.scrollHeight;
}

function clearChat() {
    conversationHistory = [];
    const container = document.getElementById('chat-messages');
    container.innerHTML = `
        <div class="msg bot-msg">
            <div class="msg-avatar"><i class="fas fa-robot"></i></div>
            <div class="msg-content">
                <div class="msg-bubble">
                    Conversation effac√©e ! üîÑ Comment puis-je vous aider ?
                    <div class="quick-topics">
                        <span onclick="sendQuick('Comment fonctionne le paiement Escrow ?')">üîê Escrow</span>
                        <span onclick="sendQuick('Comment devenir vendeur ?')">üè™ Devenir vendeur</span>
                        <span onclick="sendQuick('Comment passer une commande ?')">üõí Commander</span>
                        <span onclick="sendQuick('Quels sont les frais de commission ?')">üí∞ Commission</span>
                    </div>
                </div>
                <div class="msg-time">maintenant</div>
            </div>
        </div>
    `;
}

// Afficher le badge apr√®s 3 secondes si le chat est ferm√©
setTimeout(() => {
    if (!chatOpen) {
        document.getElementById('bubble-badge').style.display = 'flex';
    }
}, 3000);
</script>