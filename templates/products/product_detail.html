{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ product.name }} - My Kanty</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: #F8F9FA; }
        .header { background: linear-gradient(135deg, #FF9933, #006B3F); color: white; padding: 15px 0; position: sticky; top: 0; z-index: 1000; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .navbar { display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.5rem; font-weight: 800; color: white; text-decoration: none; }
        .nav-links a { color: white; text-decoration: none; padding: 8px 15px; border-radius: 5px; margin-left: 10px; transition: all 0.3s; }
        .nav-links a:hover { background: rgba(255,255,255,0.2); }
        .breadcrumb { padding: 15px 0; color: #565959; }
        .breadcrumb a { color: #006B3F; text-decoration: none; }
        .product-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin: 30px 0; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .product-gallery { position: relative; }
        .main-image { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 12px; border: 1px solid #D5D9D9; }
        .product-info { padding: 10px 0; }
        .product-category { color: #006B3F; font-size: 0.9rem; font-weight: 600; margin-bottom: 10px; }
        .product-name { font-size: 2rem; font-weight: 700; color: #0F1111; margin-bottom: 15px; line-height: 1.3; }
        .product-price { font-size: 2.5rem; font-weight: 800; color: #FF9933; margin-bottom: 20px; }
        .escrow-badge { background: linear-gradient(135deg, rgba(255,153,51,0.1), rgba(0,107,63,0.1)); border-left: 4px solid #006B3F; padding: 15px; border-radius: 8px; margin-bottom: 25px; }
        .escrow-badge h4 { color: #006B3F; margin-bottom: 8px; }
        .escrow-badge p { color: #565959; font-size: 0.9rem; }
        .quantity-section { margin-bottom: 25px; }
        .quantity-section label { display: block; font-weight: 600; margin-bottom: 10px; }
        .quantity-control { display: flex; align-items: center; gap: 15px; }
        .quantity-control button { background: #D5D9D9; border: none; width: 40px; height: 40px; border-radius: 8px; font-size: 1.2rem; cursor: pointer; font-weight: 700; transition: all 0.3s; }
        .quantity-control button:hover { background: #FF9933; color: white; }
        .quantity-control input { width: 70px; text-align: center; padding: 10px; border: 2px solid #D5D9D9; border-radius: 8px; font-size: 1.1rem; font-weight: 600; }
        .btn-add-cart { width: 100%; background: linear-gradient(135deg, #FF9933, #006B3F); color: white; padding: 18px; border: none; border-radius: 10px; font-size: 1.2rem; font-weight: 700; cursor: pointer; transition: all 0.3s; margin-bottom: 15px; }
        .btn-add-cart:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(255,153,51,0.4); }
        .btn-checkout { width: 100%; background: white; color: #006B3F; padding: 15px; border: 2px solid #006B3F; border-radius: 10px; font-size: 1.1rem; font-weight: 700; cursor: pointer; transition: all 0.3s; text-decoration: none; display: block; text-align: center; }
        .btn-checkout:hover { background: #006B3F; color: white; }
        .stock-info { padding: 10px 15px; background: #E8F5E9; border-radius: 8px; color: #006B3F; font-weight: 600; margin-bottom: 20px; display: inline-block; }
        .seller-card { background: #F8F9FA; padding: 20px; border-radius: 12px; margin-top: 30px; }
        .seller-card h3 { color: #006B3F; margin-bottom: 15px; }
        .seller-info { display: flex; gap: 15px; align-items: center; }
        .seller-avatar { width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #FF9933, #006B3F); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; font-weight: 700; }
        .description-section { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 30px; }
        .description-section h2 { color: #006B3F; margin-bottom: 15px; border-bottom: 2px solid #FFD700; padding-bottom: 10px; }
        .description-section p { color: #565959; line-height: 1.8; }
        .similar-section { margin-bottom: 60px; }
        .similar-section h2 { color: #006B3F; font-size: 1.5rem; margin-bottom: 20px; }
        .similar-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; }
        .similar-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.08); transition: all 0.3s; text-decoration: none; color: inherit; display: block; }
        .similar-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.15); }
        .similar-card img { width: 100%; height: 180px; object-fit: cover; }
        .similar-card-info { padding: 15px; }
        .notification { position: fixed; top: 80px; right: 20px; background: linear-gradient(135deg, #FF9933, #006B3F); color: white; padding: 15px 25px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 10000; font-weight: 600; display: none; }
        @media (max-width: 768px) {
            .product-layout { grid-template-columns: 1fr; }
            .product-name { font-size: 1.5rem; }
            .product-price { font-size: 2rem; }
            .nav-links { display: none; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <nav class="navbar">
                <a href="{% url 'home' %}" class="logo"><i class="fas fa-shopping-bag"></i> My Kanty</a>
                <div class="nav-links">
                    <a href="{% url 'products:product-list' %}"><i class="fas fa-th"></i> Produits</a>
                    {% if user.is_authenticated %}
                    <a href="{% url 'accounts:dashboard' %}"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
                    {% else %}
                    <a href="{% url 'accounts:login' %}"><i class="fas fa-sign-in-alt"></i> Connexion</a>
                    {% endif %}
                    <a href="{% url 'orders:cart' %}" style="position: relative;">
                        <i class="fas fa-shopping-cart"></i> Panier
                        <span id="cart-badge" style="display:none; position:absolute; top:-8px; right:-8px; background:#C7511F; color:white; border-radius:50%; padding:2px 6px; font-size:0.7rem; min-width:18px; text-align:center;">0</span>
                    </a>
                </div>
            </nav>
        </div>
    </header>

    <div class="container" style="margin-top: 20px;">
        <div class="breadcrumb">
            <a href="{% url 'home' %}">Accueil</a> &rsaquo;
            <a href="{% url 'products:product-list' %}">Produits</a> &rsaquo;
            {% if product.category %}
            <a href="{% url 'products:product-list' %}?category={{ product.category.id }}">{{ product.category.name }}</a> &rsaquo;
            {% endif %}
            {{ product.name|truncatewords:5 }}
        </div>

        <div class="product-layout">
            <!-- Galerie -->
            <div class="product-gallery">
                {% if product.main_image %}
                <img src="{{ product.main_image.url }}" alt="{{ product.name }}" class="main-image" id="main-img">
                {% else %}
                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='500' height='500'%3E%3Crect fill='%23D5D9D9' width='500' height='500'/%3E%3Ctext x='50%25' y='50%25' text-anchor='middle' dy='.3em' fill='%23565959' font-size='24'%3EAucune image%3C/text%3E%3C/svg%3E" alt="{{ product.name }}" class="main-image" id="main-img">
                {% endif %}
            </div>

            <!-- Informations produit -->
            <div class="product-info">
                {% if product.category %}
                <div class="product-category">
                    <i class="fas fa-tag"></i> {{ product.category.name }}
                </div>
                {% endif %}
                
                <h1 class="product-name">{{ product.name }}</h1>
                
                <div class="product-price">
                    {{ product.get_price|floatformat:0 }} XOF
                </div>
                
                <div class="stock-info">
                    {% if product.stock_quantity > 0 %}
                    <i class="fas fa-check-circle"></i> En stock ({{ product.stock_quantity }} disponible{{ product.stock_quantity|pluralize }})
                    {% else %}
                    <span style="color: #C7511F;"><i class="fas fa-times-circle"></i> Rupture de stock</span>
                    {% endif %}
                </div>

                <div class="escrow-badge">
                    <h4><i class="fas fa-shield-alt"></i> Achat 100% s√©curis√©</h4>
                    <p>üîê Paiement prot√©g√© par Escrow - Votre argent est s√©curis√© jusqu'√† la livraison</p>
                    <p>üì¶ Remboursement garanti si le produit n'arrive pas</p>
                </div>

                {% if product.stock_quantity > 0 %}
                <div class="quantity-section">
                    <label>Quantit√© :</label>
                    <div class="quantity-control">
                        <button onclick="changeQty(-1)">-</button>
                        <input type="number" id="qty" value="1" min="1" max="{{ product.stock_quantity }}">
                        <button onclick="changeQty(1)">+</button>
                    </div>
                </div>

                <button class="btn-add-cart" onclick="addToCartDetail()">
                    <i class="fas fa-cart-plus"></i> Ajouter au panier
                </button>
                
                <a href="{% url 'orders:cart' %}" class="btn-checkout">
                    <i class="fas fa-lock"></i> Commander maintenant
                </a>
                {% else %}
                <div style="background: #FFE6E6; padding: 15px; border-radius: 8px; color: #C7511F; text-align: center; font-weight: 600;">
                    <i class="fas fa-times-circle"></i> Ce produit est actuellement en rupture de stock
                </div>
                {% endif %}

                <!-- Vendeur -->
                <div class="seller-card">
                    <h3><i class="fas fa-store"></i> Informations Vendeur</h3>
                    <div class="seller-info">
                        <div class="seller-avatar">
                            {{ product.seller.username|first|upper }}
                        </div>
                        <div>
                            <strong>
                                {% if seller_profile %}{{ seller_profile.business_name }}
                                {% else %}{{ product.seller.username }}{% endif %}
                            </strong>
                            <p style="color: #565959; font-size: 0.9rem; margin-top: 5px;">
                                <i class="fas fa-check-circle" style="color: #006B3F;"></i> Vendeur v√©rifi√© My Kanty
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Description -->
        <div class="description-section">
            <h2><i class="fas fa-info-circle"></i> Description du produit</h2>
            <p>{{ product.description|linebreaks }}</p>
        </div>

        <!-- Produits similaires -->
        {% if similar_products %}
        <div class="similar-section">
            <h2><i class="fas fa-th"></i> Produits similaires</h2>
            <div class="similar-grid">
                {% for p in similar_products %}
                <a href="{% url 'products:product-detail' p.id %}" class="similar-card">
                    {% if p.main_image %}
                    <img src="{{ p.main_image.url }}" alt="{{ p.name }}">
                    {% else %}
                    <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='180'%3E%3Crect fill='%23D5D9D9' width='300' height='180'/%3E%3C/svg%3E" alt="{{ p.name }}">
                    {% endif %}
                    <div class="similar-card-info">
                        <div style="font-weight: 600; margin-bottom: 5px;">{{ p.name|truncatewords:4 }}</div>
                        <div style="color: #FF9933; font-weight: 700;">{{ p.get_price|floatformat:0 }} XOF</div>
                    </div>
                </a>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>

    <footer style="background: linear-gradient(135deg, #006B3F, #FF9933); color: white; padding: 30px 0; text-align: center;">
        <p>&copy; 2026 My Kanty - Togo üáπüá¨ & Niger üá≥üá™ | Paiement s√©curis√© Escrow</p>
    </footer>

    <div class="notification" id="notification"></div>

    <script>
        const productId = {{ product.id }};
        const productName = "{{ product.name|escapejs }}";
        const productPrice = {{ product.get_price }};
        const productImage = "{% if product.main_image %}{{ product.main_image.url }}{% endif %}";
        const maxStock = {{ product.stock_quantity }};

        function changeQty(change) {
            const input = document.getElementById('qty');
            let val = parseInt(input.value) + change;
            if (val < 1) val = 1;
            if (val > maxStock) val = maxStock;
            input.value = val;
        }

        function addToCartDetail() {
            const qty = parseInt(document.getElementById('qty').value);
            let cart = JSON.parse(localStorage.getItem('cart') || '[]');
            const existing = cart.find(i => i.id === productId);
            
            if (existing) {
                existing.quantity += qty;
            } else {
                cart.push({ id: productId, name: productName, price: productPrice, image: productImage, quantity: qty });
            }
            
            localStorage.setItem('cart', JSON.stringify(cart));
            showNotification('‚úÖ ' + qty + ' article(s) ajout√©(s) au panier !');
            updateBadge();
        }

        function showNotification(msg) {
            const n = document.getElementById('notification');
            n.textContent = msg;
            n.style.display = 'block';
            setTimeout(() => { n.style.display = 'none'; }, 3000);
        }

        function updateBadge() {
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            const total = cart.reduce((s, i) => s + i.quantity, 0);
            const badge = document.getElementById('cart-badge');
            if (badge) { badge.textContent = total; badge.style.display = total > 0 ? 'inline-block' : 'none'; }
        }

        updateBadge();
    </script>
{% include 'includes/chatbot.html' %}
</body>
</html>